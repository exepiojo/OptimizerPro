<!DOCTYPE html>
<html>
<head>
    <title>Optimizador de Corte</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        .chart-container { height: 70vh; }
        .loading { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); z-index: 9999; }
        .plotly .yaxis-title { font-weight: bold !important; }
        .plotly .xaxis-title { font-weight: bold !important; }
        .plotly .annotation-text { font-weight: 500 !important; }
    </style>
</head>
<body>
    <!-- ... (mantener igual el body hasta el script) ... -->

    <script>
        // ... (mantener igual hasta la función renderChart) ... 

        function renderChart(data) {
            if (data.error) {
                alert(data.error);
                return;
            }

            const materialLength = parseInt(document.getElementById('materialLength').value);
            const traces = [];
            const annotations = [];
            
            // Ordenar las barras por ID numérico
            const sortedBars = data.bars.sort((a, b) => parseInt(a.id) - parseInt(b.id));

            sortedBars.forEach((bar, index) => {
                let position = 0;
                const yPosition = `Barra ${bar.id}`;
                
                // Crear un segmento por cada pieza individual
                bar.items.forEach((item, itemIndex) => {
                    const segmentId = `${bar.id}-${item.name}-${itemIndex}`;
                    const color = colorPalette[item.name];
                    
                    // Crear el segmento principal
                    traces.push({
                        x: [item.length],
                        y: [yPosition],
                        name: item.name,
                        type: 'bar',
                        orientation: 'h',
                        marker: {
                            color: color,
                            line: {
                                color: 'white',
                                width: 2  // Grosor de la línea divisoria
                            }
                        },
                        hoverinfo: 'text',
                        hovertext: `${item.name}: ${item.length}mm`,
                        showlegend: itemIndex === 0 && !traces.some(t => t.name === item.name)
                    });

                    // Línea divisoria entre segmentos
                    if (itemIndex > 0) {
                        traces.push({
                            x: [0],
                            y: [yPosition],
                            type: 'bar',
                            orientation: 'h',
                            marker: {
                                color: 'rgba(255,255,255,0.8)',
                                line: {
                                    color: '#333',
                                    width: 1
                                }
                            },
                            width: 0.02,  // Ancho de la línea divisoria
                            base: position,
                            showlegend: false,
                            hoverinfo: 'none'
                        });
                    }

                    // Anotación si el segmento es mayor a 100mm
                    if (item.length >= 100) {
                        annotations.push({
                            x: position + (item.length/2),
                            y: yPosition,
                            text: `${item.name}<br>${item.length}mm`,
                            font: {
                                color: 'white', 
                                size: 10,
                                family: 'Arial',
                                weight: 'bold'
                            },
                            showarrow: false,
                            xanchor: 'center',
                            yanchor: 'middle'
                        });
                    }
                    
                    position += item.length;
                });

                // Desperdicio alineado a la derecha
                annotations.push({
                    x: materialLength * 1.15,
                    y: yPosition,
                    text: `Desperdicio: ${bar.waste}mm`,
                    font: {
                        color: '#e74c3c', 
                        size: 11,
                        weight: 'bold'
                    },
                    showarrow: false,
                    xanchor: 'left',
                    yanchor: 'middle'
                });
            });

            const layout = {
                title: 'Distribución de Cortes - Ordenado por Menor Desperdicio',
                barmode: 'stack',
                xaxis: {
                    title: 'Longitud Utilizada (mm)',
                    range: [0, materialLength * 1.25],
                    gridcolor: '#ecf0f1',
                    titlefont: {size: 14}
                },
                yaxis: {
                    title: 'Barras',
                    type: 'category',
                    categoryorder: 'array',
                    categoryarray: sortedBars.map(bar => `Barra ${bar.id}`),
                    titlefont: {size: 14},
                    automargin: true
                },
                plot_bgcolor: 'white',
                paper_bgcolor: '#f5f6f7',
                annotations: [
                    ...annotations,
                    {
                        x: materialLength,
                        y: 1.05,
                        xref: 'x',
                        yref: 'paper',
                        text: `Límite del material: ${materialLength}mm`,
                        showarrow: false,
                        font: {color: '#e74c3c', size: 12}
                    }
                ],
                shapes: [{
                    type: 'line',
                    x0: materialLength,
                    x1: materialLength,
                    y0: 0,
                    y1: 1,
                    yref: 'paper',
                    line: {color: '#e74c3c', width: 2, dash: 'dot'}
                }],
                legend: {
                    title: 'Artículos',
                    bgcolor: 'white',
                    bordercolor: '#2c3e50',
                    borderwidth: 1,
                    font: {size: 12}
                },
                margin: {l: 100, r: 200, t: 80, b: 80}
            };

            Plotly.newPlot('chart', traces, layout, {
                responsive: true,
                displayModeBar: false
            });
        }

        // ... (mantener igual el resto) ...
    </script>
</body>
</html>
