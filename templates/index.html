<!DOCTYPE html>
<html>
<head>
    <title>Optimizador de Corte</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        .chart-container { height: 70vh; }
        .loading { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); z-index: 9999; }
        .plotly .yaxis-title { font-weight: bold !important; }
        .plotly .xaxis-title { font-weight: bold !important; }
        .plotly .annotation-text { font-weight: 500 !important; }
    </style>
</head>
<body>
    <div class="container py-5">
        <div class="loading" id="loading">
            <div class="d-flex justify-content-center align-items-center h-100">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Cargando...</span>
                </div>
            </div>
        </div>
        
        <h1 class="mb-4">Optimizador de Corte</h1>
        
        <div class="card mb-4">
            <div class="card-body">
                <div class="row g-3 mb-3">
                    <div class="col-md-4">
                        <input type="number" id="materialLength" class="form-control" 
                               placeholder="Largo del material (mm)" value="2000">
                    </div>
                    <div class="col-md-4">
                        <button class="btn btn-success w-100" onclick="addArticle()">
                            ➕ Agregar Artículo
                        </button>
                    </div>
                    <div class="col-md-4">
                        <button class="btn btn-primary w-100" onclick="optimize()">
                            ⚡ Optimizar
                        </button>
                    </div>
                </div>
                
                <div id="articlesContainer"></div>
            </div>
        </div>
        
        <div class="card">
            <div class="card-body">
                <div id="chart" class="chart-container"></div>
            </div>
        </div>
    </div>

    <script>
        let articles = [];
        const colorPalette = {
            'A': '#2ecc71', 'B': '#3498db', 'C': '#e74c3c',
            'D': '#9b59b6', 'E': '#f1c40f', 'F': '#1abc9c',
            'G': '#e67e22', 'H': '#34495e', 'I': '#95a5a6'
        };

        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }

        function addArticle(article = {name: '', length: '', quantity: ''}) {
            const id = Date.now();
            articles.push({id, ...article});
            
            const html = `
                <div class="row g-3 mb-3" id="article-${id}">
                    <div class="col-md-4">
                        <input type="text" class="form-control" placeholder="Nombre" 
                               value="${article.name}" onchange="updateArticle(${id}, 'name', this.value)">
                    </div>
                    <div class="col-md-3">
                        <input type="number" class="form-control" placeholder="Longitud" 
                               value="${article.length}" onchange="updateArticle(${id}, 'length', this.value)">
                    </div>
                    <div class="col-md-3">
                        <input type="number" class="form-control" placeholder="Cantidad" 
                               value="${article.quantity}" onchange="updateArticle(${id}, 'quantity', this.value)">
                    </div>
                    <div class="col-md-2">
                        <button class="btn btn-danger w-100" onclick="removeArticle(${id})">
                            ❌ Eliminar
                        </button>
                    </div>
                </div>
            `;
            
            document.getElementById('articlesContainer').insertAdjacentHTML('beforeend', html);
        }

        function updateArticle(id, field, value) {
            const article = articles.find(a => a.id === id);
            article[field] = value;
        }

        function removeArticle(id) {
            articles = articles.filter(a => a.id !== id);
            document.getElementById(`article-${id}`).remove();
        }

        async function optimize() {
            showLoading(true);
            
            try {
                const payload = {
                    materialLength: parseInt(document.getElementById('materialLength').value),
                    articles: articles.map(a => ({
                        name: a.name || `Artículo ${a.id}`,
                        length: parseInt(a.length),
                        quantity: parseInt(a.quantity)
                    }))
                };

                const response = await fetch('/optimize', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });

                if (!response.ok) throw new Error(`Error HTTP: ${response.status}`);
                
                const data = await response.json();
                renderChart(data);
                
            } catch (error) {
                console.error('Error:', error);
                alert(`Error: ${error.message}`);
            } finally {
                showLoading(false);
            }
        }

        function renderChart(data) {
            if (data.error) {
                alert(data.error);
                return;
            }

            const materialLength = parseInt(document.getElementById('materialLength').value);
            const traces = [];
            const annotations = [];
            
            // Ordenar las barras por ID numérico
            const sortedBars = data.bars.sort((a, b) => parseInt(a.id) - parseInt(b.id));

            sortedBars.forEach((bar, index) => {
                let position = 0;
                let currentItems = [];
                const yPosition = `Barra ${bar.id}`;
                
                // Agrupar elementos consecutivos
                bar.items.forEach((item, i) => {
                    if (i === 0 || item.name !== bar.items[i-1].name) {
                        currentItems.push({
                            name: item.name,
                            length: item.length,
                            count: 1
                        });
                    } else {
                        currentItems[currentItems.length-1].count++;
                    }
                });

                // Crear segmentos
                currentItems.forEach(item => {
                    const totalLength = item.length * item.count;
                    const segmentId = `${bar.id}-${item.name}`;
                    
                    traces.push({
                        x: [totalLength],
                        y: [yPosition],
                        name: item.name,
                        type: 'bar',
                        orientation: 'h',
                        marker: {
                            color: colorPalette[item.name],
                            line: {color: 'white', width: 1.5}
                        },
                        hoverinfo: 'text',
                        hovertext: `${item.count} × ${item.length}mm (${item.name})`,
                        showlegend: !traces.some(t => t.name === item.name)
                    });

                    // Anotaciones solo si el segmento es mayor a 150mm
                    if (totalLength >= 150) {
                        annotations.push({
                            x: position + (totalLength/2),
                            y: yPosition,
                            text: `${item.name}<br>${item.length}×${item.count}`,
                            font: {
                                color: 'white', 
                                size: 10,
                                family: 'Arial'
                            },
                            showarrow: false,
                            xanchor: 'center',
                            yanchor: 'middle'
                        });
                    }
                    position += totalLength;
                });

                // Desperdicio alineado a la derecha
                annotations.push({
                    x: materialLength * 1.15,
                    y: yPosition,
                    text: `Desperdicio: ${bar.waste}mm`,
                    font: {
                        color: '#e74c3c', 
                        size: 11,
                        weight: 'bold'
                    },
                    showarrow: false,
                    xanchor: 'left',
                    yanchor: 'middle'
                });
            });

            const layout = {
                title: 'Distribución de Cortes - Ordenado por Menor Desperdicio',
                barmode: 'stack',
                xaxis: {
                    title: 'Longitud Utilizada (mm)',
                    range: [0, materialLength * 1.25],
                    gridcolor: '#ecf0f1',
                    titlefont: {size: 14}
                },
                yaxis: {
                    title: 'Barras',
                    type: 'category',
                    categoryorder: 'array',
                    categoryarray: sortedBars.map(bar => `Barra ${bar.id}`),
                    titlefont: {size: 14},
                    automargin: true
                },
                plot_bgcolor: 'white',
                paper_bgcolor: '#f5f6f7',
                annotations: [
                    ...annotations,
                    {
                        x: materialLength,
                        y: 1.05,
                        xref: 'x',
                        yref: 'paper',
                        text: `Límite del material: ${materialLength}mm`,
                        showarrow: false,
                        font: {color: '#e74c3c', size: 12}
                    }
                ],
                shapes: [{
                    type: 'line',
                    x0: materialLength,
                    x1: materialLength,
                    y0: 0,
                    y1: 1,
                    yref: 'paper',
                    line: {color: '#e74c3c', width: 2, dash: 'dot'}
                }],
                legend: {
                    title: 'Artículos',
                    bgcolor: 'white',
                    bordercolor: '#2c3e50',
                    borderwidth: 1,
                    font: {size: 12}
                },
                margin: {l: 100, r: 200, t: 80, b: 80}
            };

            Plotly.newPlot('chart', traces, layout, {
                responsive: true,
                displayModeBar: false
            });
        }

        // Artículos iniciales
        addArticle({name: 'A', length: '100', quantity: '5'});
        addArticle({name: 'B', length: '300', quantity: '10'});
    </script>
</body>
</html>
