<!DOCTYPE html>
<html>
<head>
    <title>Optimizador de Corte</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        .chart-container { height: 70vh; }
        .loading { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); z-index: 9999; }
    </style>
</head>
<body>
    <div class="container py-5">
        <div class="loading" id="loading">
            <div class="d-flex justify-content-center align-items-center h-100">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Cargando...</span>
                </div>
            </div>
        </div>
        
        <h1 class="mb-4">Optimizador de Corte</h1>
        
        <div class="card mb-4">
            <div class="card-body">
                <div class="row g-3 mb-3">
                    <div class="col-md-4">
                        <input type="number" id="materialLength" class="form-control" 
                               placeholder="Largo del material (mm)" value="2000">
                    </div>
                    <div class="col-md-4">
                        <button class="btn btn-success w-100" onclick="addArticle()">
                            ➕ Agregar Artículo
                        </button>
                    </div>
                    <div class="col-md-4">
                        <button class="btn btn-primary w-100" onclick="optimize()">
                            ⚡ Optimizar
                        </button>
                    </div>
                </div>
                
                <div id="articlesContainer"></div>
            </div>
        </div>
        
        <div class="card">
            <div class="card-body">
                <div id="chart" class="chart-container"></div>
            </div>
        </div>
    </div>

    <script>
        let articles = [];
        
        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }

        function addArticle(article = {name: '', length: '', quantity: ''}) {
            const id = Date.now();
            articles.push({id, ...article});
            
            const html = `
                <div class="row g-3 mb-3" id="article-${id}">
                    <div class="col-md-4">
                        <input type="text" class="form-control" placeholder="Nombre" 
                               value="${article.name}" onchange="updateArticle(${id}, 'name', this.value)">
                    </div>
                    <div class="col-md-3">
                        <input type="number" class="form-control" placeholder="Longitud" 
                               value="${article.length}" onchange="updateArticle(${id}, 'length', this.value)">
                    </div>
                    <div class="col-md-3">
                        <input type="number" class="form-control" placeholder="Cantidad" 
                               value="${article.quantity}" onchange="updateArticle(${id}, 'quantity', this.value)">
                    </div>
                    <div class="col-md-2">
                        <button class="btn btn-danger w-100" onclick="removeArticle(${id})">
                            ❌ Eliminar
                        </button>
                    </div>
                </div>
            `;
            
            document.getElementById('articlesContainer').insertAdjacentHTML('beforeend', html);
        }

        function updateArticle(id, field, value) {
            const article = articles.find(a => a.id === id);
            article[field] = value;
        }

        function removeArticle(id) {
            articles = articles.filter(a => a.id !== id);
            document.getElementById(`article-${id}`).remove();
        }

        async function optimize() {
            showLoading(true);
            
            try {
                const payload = {
                    materialLength: parseInt(document.getElementById('materialLength').value),
                    articles: articles.map(a => ({
                        name: a.name || `Artículo ${a.id}`,
                        length: parseInt(a.length),
                        quantity: parseInt(a.quantity)
                    }))
                };

                const response = await fetch('/optimize', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });

                if (!response.ok) throw new Error(`Error HTTP: ${response.status}`);
                
                const data = await response.json();
                renderChart(data);
                
            } catch (error) {
                console.error('Error:', error);
                alert(`Error: ${error.message}`);
            } finally {
                showLoading(false);
            }
        }

        function renderChart(data) {
            if (data.error) {
                alert(data.error);
                return;
            }

            const traces = data.bars.map(bar => ({
                x: [bar.total, bar.waste],
                y: [`Barra ${bar.id}`],
                name: `Barra ${bar.id}`,
                type: 'bar',
                orientation: 'h',
                hoverinfo: 'text',
                hovertext: bar.items.map(item => 
                    `${item.name}: ${item.quantity} × ${item.length}mm`
                ).join('<br>'),
                marker: {
                    color: ['#2ecc71', '#e74c3c'],
                    line: {width: 1, color: '#333'}
                }
            }));

            const layout = {
                title: 'Distribución de Barras',
                barmode: 'stack',
                showlegend: false,
                xaxis: {title: 'Milímetros'},
                yaxis: {title: 'Barras', automargin: true},
                hoverlabel: {bgcolor: '#fff', font: {size: 12}}
            };

            Plotly.newPlot('chart', traces, layout);
        }

        // Artículos iniciales
        addArticle({name: 'A', length: '100', quantity: '5'});
        addArticle({name: 'B', length: '300', quantity: '10'});
    </script>
</body>
</html>
