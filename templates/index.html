<!DOCTYPE html>
<html>
<head>
    <title>Optimizador de Corte</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <style>
        .chart-container { height: 70vh; }
        .loading { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); z-index: 9999; }
        .plotly .yaxis-title { font-weight: bold !important; }
        .plotly .xaxis-title { font-weight: bold !important; }
    </style>
</head>
<body>
    <div class="container py-5">
        <div class="loading" id="loading">
            <div class="d-flex justify-content-center align-items-center h-100">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Cargando...</span>
                </div>
            </div>
        </div>
        
        <h1 class="mb-4">Optimizador de Corte</h1>
        
        <div class="card mb-4">
            <div class="card-body">
                <div class="row g-3 mb-3">
                    <div class="col-md-4">
                        <input type="number" id="materialLength" class="form-control" 
                               placeholder="Largo del material (mm)" value="2000">
                    </div>
                    <div class="col-md-4">
                        <button class="btn btn-success w-100" onclick="addArticle()">
                            ➕ Agregar Artículo
                        </button>
                    </div>
                    <div class="col-md-4">
                        <button class="btn btn-primary w-100" onclick="optimize()">
                            ⚡ Optimizar
                        </button>
                    </div>
                </div>
                
                <div id="articlesContainer"></div>
            </div>
        </div>
        
        <div class="card">
            <div class="card-body">
                <div id="chart" class="chart-container"></div>
            </div>
        </div>
    </div>

    <script>
        let articles = [];
        const colorPalette = {
            'A': '#2ecc71', 'B': '#3498db', 'C': '#e74c3c',
            'D': '#9b59b6', 'E': '#f1c40f', 'F': '#1abc9c',
            'G': '#e67e22', 'H': '#34495e', 'I': '#95a5a6'
        };

        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
        }

        function addArticle(article = {name: '', length: '', quantity: ''}) {
            const id = Date.now();
            articles.push({id, ...article});
            
            const html = `
                <div class="row g-3 mb-3" id="article-${id}">
                    <div class="col-md-4">
                        <input type="text" class="form-control" placeholder="Nombre" 
                               value="${article.name}" onchange="updateArticle(${id}, 'name', this.value)">
                    </div>
                    <div class="col-md-3">
                        <input type="number" class="form-control" placeholder="Longitud" 
                               value="${article.length}" onchange="updateArticle(${id}, 'length', this.value)">
                    </div>
                    <div class="col-md-3">
                        <input type="number" class="form-control" placeholder="Cantidad" 
                               value="${article.quantity}" onchange="updateArticle(${id}, 'quantity', this.value)">
                    </div>
                    <div class="col-md-2">
                        <button class="btn btn-danger w-100" onclick="removeArticle(${id})">
                            ❌ Eliminar
                        </button>
                    </div>
                </div>
            `;
            
            document.getElementById('articlesContainer').insertAdjacentHTML('beforeend', html);
        }

        function updateArticle(id, field, value) {
            const article = articles.find(a => a.id === id);
            article[field] = value;
        }

        function removeArticle(id) {
            articles = articles.filter(a => a.id !== id);
            document.getElementById(`article-${id}`).remove();
        }

        async function optimize() {
            showLoading(true);
            
            try {
                const payload = {
                    materialLength: parseInt(document.getElementById('materialLength').value),
                    articles: articles.map(a => ({
                        name: a.name || `Artículo ${a.id}`,
                        length: parseInt(a.length),
                        quantity: parseInt(a.quantity)
                    }))
                };

                const response = await fetch('/optimize', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });

                if (!response.ok) throw new Error(`Error HTTP: ${response.status}`);
                
                const data = await response.json();
                renderChart(data);
                
            } catch (error) {
                console.error('Error:', error);
                alert(`Error: ${error.message}`);
            } finally {
                showLoading(false);
            }
        }

function renderChart(data) {
    if (data.error) {
        alert(data.error);
        return;
    }

    const materialLength = data.material_length;
    const traces = [];
    const annotations = [];
    
    // Ordenar barras por ID
    const sortedBars = data.bars.sort((a, b) => a.id - b.id);

    sortedBars.forEach((bar, index) => {
        let position = 0;
        
        bar.items.forEach(item => {
            const totalLength = item.total;
            
            traces.push({
                x: [totalLength],
                y: [bar.id],
                name: item.name,
                type: 'bar',
                orientation: 'h',
                marker: {
                    color: colorPalette[item.name],
                    line: {color: 'white', width: 1.5}
                },
                hoverinfo: 'text',
                hovertext: `${item.quantity} × ${item.length}mm = ${totalLength}mm`,
                showlegend: traces.findIndex(t => t.name === item.name) === -1
            });

            if (totalLength >= 100) {
                annotations.push({
                    x: position + (totalLength/2),
                    y: bar.id,
                    text: `${item.quantity}×${item.length}mm`,
                    font: {color: 'white', size: 10},
                    showarrow: false,
                    xanchor: 'center',
                    yanchor: 'middle'
                });
            }
            position += totalLength;
        });

        annotations.push({
            x: materialLength + 50,
            y: bar.id,
            text: `Desperdicio: ${bar.waste}mm`,
            font: {color: '#e74c3c', size: 11},
            showarrow: false,
            xanchor: 'left'
        });
    });

    const layout = {
        title: 'Distribución de Cortes - Ordenado por Menor Desperdicio',
        barmode: 'stack',
        xaxis: {
            title: 'Longitud Utilizada (mm)',
            range: [0, materialLength * 1.2],
            gridcolor: '#ecf0f1',
            titlefont: {size: 14}
        },
        yaxis: {
            title: 'Barras',
            type: 'category',
            tickvals: sortedBars.map(bar => bar.id),
            ticktext: sortedBars.map(bar => `Barra ${bar.id}`),
            titlefont: {size: 14},
            autorange: 'reversed'  // Ordenar de arriba hacia abajo
        },
        plot_bgcolor: 'white',
        paper_bgcolor: '#f5f6f7',
        annotations: annotations,
        shapes: [{
            type: 'line',
            x0: materialLength,
            x1: materialLength,
            y0: sortedBars[0]?.id || 0,
            y1: sortedBars[sortedBars.length-1]?.id || 1,
            line: {color: '#e74c3c', width: 2, dash: 'dot'}
        }],
        legend: {
            title: 'Artículos',
            bgcolor: 'white',
            bordercolor: '#2c3e50',
            borderwidth: 1,
            font: {size: 12}
        },
        margin: {l: 120, r: 40, t: 80, b: 80}
    };

    Plotly.newPlot('chart', traces, layout, {
        responsive: true,
        displayModeBar: true
    });
}

        // Artículos iniciales
        addArticle({name: 'A', length: '100', quantity: '5'});
        addArticle({name: 'B', length: '300', quantity: '10'});
    </script>
</body>
</html>
